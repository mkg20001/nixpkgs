{ lib
, pkg-config
, buildGoModule
, fetchFromGitHub
, makeWrapper
, coreutils
, gnupg
, gnutar
, squashfsTools
, debootstrap
, sks
, curl
}:

let
  bins = [
    coreutils
    gnupg
    gnutar
    squashfsTools
    debootstrap
  ];
  binPath = lib.makeBinPath bins;
in
buildGoModule rec {
  pname = "distrobuilder";
  version = "1.2";

  vendorSha256 = "sha256-G5FUO6Ul4dA4MZZI9Ho1kE9ptX31tAWak9rWAoD/iuU=";

  src = fetchFromGitHub {
    owner = "lxc";
    repo = "distrobuilder";
    rev = "distrobuilder-${version}";
    sha256 = "CE3Tq0oWpVZnSfBBY3/2E2GdZLFsO0NzkPABT8lu+TY=";
    fetchSubmodules = false;
  };

  buildInputs = bins;

  doCheck = false;

  nativeBuildInputs = [
    pkg-config
    makeWrapper
    sks
    curl
  ] ++ bins;

  postPatch = ''
    T=$(mktemp -d)
    pushd "$T"
    sks build
    sks db -debug & skspid=$!
    sleep 5s
    curl 'http://localhost:11371/pks/add' \
      -H 'Connection: keep-alive' \
      -H 'Pragma: no-cache' \
      -H 'Cache-Control: no-cache' \
      -H 'Origin: http://localhost:11371' \
      -H 'Upgrade-Insecure-Requests: 1' \
      -H 'DNT: 1' \
      -H 'Content-Type: application/x-www-form-urlencoded' \
      -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36' \
      -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9' \
      -H 'Referer: http://localhost:11371/' \
      -H 'Accept-Language: de,pl;q=0.9,en;q=0.8,en-US;q=0.7,de-DE;q=0.6' \
      -H 'sec-gpc: 1' \
      --data-raw 'keytext=-----BEGIN+PGP+PUBLIC+KEY+BLOCK-----%0D%0A%0D%0AmQINBFLNGn4BEADOg%2B9eWP%2F4zCkENJJKbpo4j6GjqBQrO2hunP4z3LkA6v02OTFo%0D%0AfW5Ut5onqXQvmBI4eumHDORaH75dvELCYnrhlbwBFlGblmAxhDKbQVKF47BWG5aJ%0D%0Ajs8w7wrv2GaOMbzjucfumLinBgLqdnaUlJmda%2FhrPdnWG5Ia5bM5dAS%2BqLfH%2FC3A%0D%0AeOcJHzBZMdjPo4Q7OmFJVfQWZAOkNzKGu%2F%2FyDdnMVMJBw54t9khXQVV6GnptnzqR%0D%0ASZEZsVVQazSZjktp8rFOg%2BF6FrWFgCnYikc%2FIQ7pckR5VPkMWHyESRFLHa%2FGace7%0D%0AhzFcLMqASLZZsG6wP5RDmbAOEySixFuiZKH8tgCEtd%2B8pwSY8%2FqnDTVq7ZXD4t%2FR%0D%0AKFzvUfvOZVohtsU0%2BMvHAvr6gTiApcrpqOt9HewfYHSiAeXVteSa5l7l%2Bv33IKHE%0D%0AXRITUWYZ3bwcn7Qe%2Fln4%2BUcvIg8Ch%2B9U%2BhBb51giSaEBEYwhjjXNe2yc%2Ft%2FLF9y6%0D%0AP8OZmfVJ7XSKC5ud5yLNl%2Fw9R8cL9%2FcinucM1OGWQgiJlrnxo%2FIBZ7NFDA3DA3UE%0D%0Aw4ogBhjIWTHHaIxHmFYM0HESnG7nMOMemfUCqyRETZHbuP6VU5h5CxxteMUs33hN%0D%0ArZIQsAzbbgc50eAK3Tplsne4R20EgvaInHACrOq6wHt8A0TAe4vWdN5inwARAQAB%0D%0AtCJUaG9tYXMgSGlwcCA8dGhvbWFzaGlwcEBnbWFpbC5jb20%2BiQJXBBMBCgBBAhsB%0D%0ABQsJCAcDBRUKCQgLBRYDAgEAAh4BAheAAhkBFiEESNal9C1gV7%2BaN4AEXeiUmomc%0D%0AjZkFAl4W8EcFCQ0sWskACgkQXeiUmomcjZksdw%2F%2BPrhC4sZxcMZXfB2MjiZixA3b%0D%0AkKy%2FKUB574u0DK2DM%2BeD7A6SFkKCT5fdBldpuyonH%2B3%2Fz1Ek%2BuorW%2FMD9XQnWPCU%0D%0AXV0t7fyGVFdEyAYe%2BYGoQHBT2KVw0WGz3mRKLGyKqAwKVoZAKqENDZVcqLZzpq%2Fp%0D%0Av5seht5hszSzNHUJSOVddO3oVgG5WOnhq7orcDgrSqP9KyNH%2BQTStOawiZDbUXTl%0D%0AwAleqn7F5hs4q0wfXHfXoPporrfzr0BXFLhmINiYB5tBOAkKQ%2FXNKx5yVeGDdf93%0D%0AAOGhCaNwC5DTZS9ZEU0hoUKUlcjcwcrHMGKFmSszBHSuS9bg%2FLuaCAA9W1%2FoCsaY%0D%0AU9JaEZj56PEReOru5c1nVkLCGIOnmf9kgnjlRbgZpP%2BnucnXtYIslxiXPXI2ytky%0D%0AkB4kl%2BJ3KZnplNS9noLwHCPX1NS%2BZJXrVOib1oHwwUjSJ7YG7VSWsnvbYbiIA3lv%0D%0AaaZHO7%2Fdhjql9M%2BvfcEHqoaWcWuC4XuN%2F30TwAXu7mdnBcDjyC6hHr1N6BBb%2BpN4%0D%0AkVI3o1Ew7zFM1vWWvQQigLtT7BR0J7XAVfxq7G6VtR9q7BZrD6UpCc1yzcSafbNs%0D%0Ax6K1OXYa1ud9uVH2PmLgebiS4OJFktCGv%2BnFo7REpHt4wSWNu8KoE6mzEK7eApTi%0D%0AQihW7ufmyfLq%2FeuNlp%2B0IlRob21hcyBIaXBwIDx0aG9tYXMuaGlwcEBzdXNlLmNv%0D%0AbT6JAlQEEwEKAD4CGwEFCwkIBwMFFQoJCAsFFgIDAQACHgECF4AWIQRI1qX0LWBX%0D%0Av5o3gARd6JSaiZyNmQUCXhbwSgUJDSxayQAKCRBd6JSaiZyNmTciD%2F9X1Gg%2BaKai%0D%0AoJ05VS0o2zxQT6dNW4JgjieWbO5y%2BK47hnAgI5Zxr0e5ZmS1YkhM4QRIyFJ1h63G%0D%0A2MnU79%2FYzXaxVZUP78U%2B%2BJuT7erPnFToSdQ%2FDh0LdLnfsgmRTz6icvNqc4T9%2FkHt%0D%0ADlZAleBGHUcEpKEwBCglUK7sgluyS5Oh1okPQsIhvnrzSWNZYtd77J%2BP0nrewLZ5%0D%0Aj69kIuEpvoSziR1d3SFgTchaL07GZKUrw3qCYNk7NIhYiOA%2BAVGHtQlrYaG0UPSl%0D%0AT3O56KXS4%2BmIhJUMSF6oBouN7gKCMnd4p6bmvPUWOdqrOolgUy%2BNWrIrKncxz0Ou%0D%0AuXCEy06QE24QLJcppoS5K3Pj5mLIgxqX1T4AaNf7lQ%2BsTvFC0KXJrWAzZ9yraacP%0D%0ALv4sojeR4D8ilAxVvUohZLs%2FKyMilGbq19ZPCkmmJuOFfy2pTsK8V60zjXyHBdFO%0D%0AbkX6tYvk6z%2FeBO1f0SAXMEEv8c7UK32pXVUCQ9Mc4hQ8RA69MjVdT1uganzELquI%0D%0AqytuhJQ5Lc7XXPB25h%2FCtR7%2BQim5DI6EgsydtFmhJ8pd0e8DqUYtyqXzBhpJGhBL%0D%0A%2ByGQRMWir3xSoUub3VY7KmT93k%2FNgauqC3o8mWAZgKEh2AQXjdxIHzWQr0TDuulW%0D%0ANj3k1MrlzKU1Gzt0aloo30caTH4xrp%2BDCLQbVGhvbWFzIEhpcHAgPHRoaXBwQHN1%0D%0Ac2UuZGU%2BiQJUBBMBCgA%2BAhsBBQsJCAcDBRUKCQgLBRYCAwEAAh4BAheAFiEESNal%0D%0A9C1gV7%2BaN4AEXeiUmomcjZkFAl4W8EkFCQ0sWskACgkQXeiUmomcjZlykhAApxvx%0D%0A1Wp0X1PsqbnjQbExjVPtuIOXULxOvIwCwlEqhXgr3LrGB7h4QlLK0EAgZ9Kqe915%0D%0Ark8y9kjRaGKok0IU1OuQcTffe7fjUPBpoJBn0ZSuLkfH4s8ujlyXN4yxy%2BvbgOFD%0D%0Afcsk5cns463FBuZCaZ5VVpg6PR2c%2FXfaM8qfjhxireRdaQkSklrgZaSxQE4w4B9K%0D%0Ay0AS%2BLvA2yNO2U4ewx41fdYZ6CATuY3LXoKI3046u%2BOdAAdJVQVcJJhBasMyakEy%0D%0AgtUA59QFAbKb3%2BVJYgD2vroPz9CGmpKpQPaWQIZ9ZUygvLeLF9SK4zKHoP3%2Btkrx%0D%0ALoCNaUKfqDGch%2Fknaa89ZbolTuNStizSAPnvfD7WYkv9Pe3AiwvRbBrkWpM6vFIb%0D%0AXHv%2B0z2EINDT9LrlMroeaWt2H%2Bq2N%2FrEqZAxNZkQ1m%2Bjk4MZGgrdGEpm3bbZtmGg%0D%0A%2Fx3E%2BoYLtpl0GyfVT895W2yAnFzKYqQmmeso68sU34fjD5Evdotyt79M1bR6ABAZ%0D%0AmJaAOLI0nrJt0ikQx%2FkSdqmeRrFhnz2POyEQokBr%2BDoW3wIzDdXe7rceJ%2FIUBbgr%0D%0AMv%2BZfHt1bH%2BwrLjyY%2BeIhB2%2FFqtZpDTZgDEiyBFKTkIagaDnRm56rM0yz7AjzVdO%0D%0Al8WUXMeinU4ZcDJW%2B0kVy4QOmiZ2fB74IkpW7R20HFRob21hcyBIaXBwIDx0aGlw%0D%0AcEBzdXNlLmNvbT6JAlQEEwEKAD4CGwEFCwkIBwMFFQoJCAsFFgIDAQACHgECF4AW%0D%0AIQRI1qX0LWBXv5o3gARd6JSaiZyNmQUCXhbwSQUJDSxayQAKCRBd6JSaiZyNmaZS%0D%0AD%2F9qJwjCqFwGA3qlax0g1JbQdLcJHqIn1Mwg6Mj01cmI91MNZkyCbETe6MWnaMPc%0D%0AnWkYmaGmgqtL4PbeWPJsw717znGEVY9jXtC6JBpwmeF4WtS7OG6xABwOZcWNwH2k%0D%0A%2FTy8CSlp4YG%2Bx27EwmCJTc5ReaPcmBcWduKEODsyx%2F7uCnw7oA6MGMz%2BetY3m8vf%0D%0A0zhfH%2BjAfIj1SVF%2B3K6C%2FeCYXoQe90pG7SUMckXrsJBMhIyDHjBjbeRFOAm4oo7D%0D%0AmaLro9RBV2eLIY%2BlXRh1VbOjZ4w2wC8blCMg3dIiG7iyEPVDvrbdXgJBonWwLj4K%0D%0Acg353TmBR%2F47YRyvzwQ0vcZhsvRZq%2BDBG1PJpk%2BoeqF5Xf6NPF2qdRduf9iYg%2FOC%0D%0AHrxm910%2F5SRmfR8HmslhAVUmlg%2BDH65ML5cI2X6qHu%2FhYUqIu%2F9mcluWJsD4KU6X%0D%0ATpSlaHx9UGfCGYN1Ob6WwFDx9hSvrG%2BIWc4i6YHHcHm945FvZbChvM2K7sAIXb%2F8%0D%0Au1xAIVwlPDmV0VEfMe7Ov2IgTFiPVjbfgwsTHm7BpjlkLGciyKRBZL2EXw869KVB%0D%0AlTKtkyiD73ulr7Gy0GYxrWh8L1OuWprMzg%2BB88YZmzcAA7JO2i55I5Z4z5f1%2F5BZ%0D%0AOMnKo2g%2B3ZIl%2BurdR2FAX0wnpHOx14qA6ludSP8xxmgSELQoVGhvbWFzIEhpcHAg%0D%0APHRob21hcy5oaXBwQGhzLWF1Z3NidXJnLmRlPokCVAQTAQoAPgIbAQULCQgHAwUV%0D%0ACgkICwUWAwIBAAIeAQIXgBYhBEjWpfQtYFe%2FmjeABF3olJqJnI2ZBQJeFvBIBQkN%0D%0ALFrJAAoJEF3olJqJnI2ZFeUP%2F1emB6Puts8quXyaVs5fD%2FJlyH4%2BTRRNK84qUFS%2B%0D%0ALy5iZz5ezOLnfSGtKhjVtBz6ccy5yhm3pBlNODTqBI5dgW55VICt7h81pgqqeDZg%0D%0Ai2p9trQ%2Fw79UfQxBTKvjKRtfEXzSrTTs7%2BCZPpkR9%2FhZ8JBpO%2BjgHgCOuoG43myB%0D%0AmRurM%2FUG84jrsWUYmWSn26tb%2FNuuhyQDgP%2FuccPnRXX4ja9MDTZYIlbG5V1lj2ho%0D%0AoL4gb5CGiaYM8QmcWpF0e51fykFrWyhZ4TLnpaEITC8hYpQEZdzjsziTYWTH5yBa%0D%0Ay2CRqgblIGj37Cv4Pn2cykxIWBSCXAYSlMAagrYQrASVDNHf8xu7uzQ8yWzJlqPj%0D%0A6ibCzLGWal0XCDDPYzBVuA0gVEjzl9SXCEufEwfc2dqZJhU8B4dnTF1yYdKKWFs4%0D%0AARyV0qcGTHNVpbXmTjUc%2FkRrqVVCXMzqLCZo5AT2GPDfTnZWhKRqk0gzxAfp3oKi%0D%0A3yOqJu2Gmtq3NmuzXUcpq2qs9jhYresrklNnofRjeeuCjOkOGDCjk8Tndfn279If%0D%0Ab1XJRD68wF1t%2FFZ%2FtsESuixCqhunYVre2QWcNEwqgrqEn60Ytewe5fRXrhNE%2FBVB%0D%0AsLsVY9aCLTSQP5MDYsNXGpldhDg1aIzaHjDMMB4l7CtGvo2LldopW6gNEhjjidEh%0D%0AWFj0tCdUaG9tYXMgSGlwcCA8dGhvbWFzLmhpcHBAY2Fub25pY2FsLmNvbT6JAlQE%0D%0AEwEKAD4CGwEFCwkIBwMFFQoJCAsFFgIDAQACHgECF4AWIQRI1qX0LWBXv5o3gARd%0D%0A6JSaiZyNmQUCXhbwSAUJDSxayQAKCRBd6JSaiZyNmRnQD%2F9xs1pVNERxb6E0JSMT%0D%0AQdRKeIyN4NLvL9dLhku6VxrGQmvCcNu5%2FwwVC%2BjfT%2B8khofsczYBXEvytBMSYfEs%0D%0AmoTWeBOLrDU0IM5ADakKdIpLuCpGGVD5Bho3vtrxbvacH2AP4nimOOTwSTeMYTts%0D%0Ac1vYX2oyTKWQa44iwXEDa3EVxvIQXjgb4CWihVVMJqXuDz4tHjY4Yv1QcCaympB%2B%0D%0AORJAoTjmYzHxZ8RzNSfX%2BPvenhkO9g8XW%2B99NPxYD842sNwj7grxHYbGInVb3Oio%0D%0AtUC2uANvFetIoRo3M0neGh1tyXr2g0SIdiWB9A9YCB3gUxC1rTsBsL32gci7f5ll%0D%0AzxkdSBFGMXmv86ADHupOzTHPOzT9p5ECf9hEwwZB2O0DuWrsfWjN4Y7MCmtvTHYT%0D%0AMlhp%2B%2F8NP3xDRREBbB%2FoCKpJdBl3M7DiwsATWpG54Uz1sr9E84jB4%2FNSRlsbYjj3%0D%0ACCIxCPy5tiJEMKHfioqd0JlP8IOa9HvwDSeP9WEdMRK47%2Bfr44yUsY1U1FeGmprT%0D%0AWfsHoUgYxmQfLcP30BM%2FNnXy4%2FfH2D85hm2DB4d%2BOxLTpdMaVFb7b5qdmuYAfVbm%0D%0ANq6Uwb6S5OZdKSKA12YiFFWWTJ2nILlGeTxUCY3fcyt%2FTDGiuZRNEzSC4ZHp3cso%0D%0AL1qry79hqBboB0EcPQfDvpAaPrkCDQRSzRuGARAAwW2TZm3W%2FOHUdXrXEGkZUgPV%0D%0AL8fj0Djl5pmi3Ty%2B61KXj7r6iZlY18A1Wd1KsVnlsV7gG4uJFdF%2FzmXxhpi8GTY4%0D%0AXciGA%2FL1NE4zPWTxCt5%2FJQX9LDGB6Fjw5FQ02kHX73aWO3CPjaxAMumRDoyFjcL%2F%0D%0AjBuM%2BTOo1le3YkciNcXKoME%2FFRcCVZCfSD%2BZ%2BV46Oht8G2FnS6m2mogjf9%2FlL8pA%0D%0AYJwXsaZaCrPNtzvqOeNlgIEYcR8HUrzEuN%2BMpAK5gqYDvrkOn7fKuAjVxWkGEaXM%0D%0AgLh7z%2BUiyEPaaByMpEJxUMZjlJwknITaGnw3AA%2BP7ZkLuFCFqWxFyC1aDsUelHYl%0D%0A2Z41nuMji%2BRZzaJD4GxYsjOkt6TuNAg0VbUVadiT4EZeH6UyXdPx8V1mtgTCPRLm%0D%0ABIPcc5AkJixtSg69YJc6zLJrxAgoISs98TgcXQO2b9A8AzY9WjvQpKJexJdq2ef2%0D%0AZ%2FGpsYfKThrMWKECaahJLoBq%2FzH2vCJWyek%2BYtcejVYv%2Bt8UJoGJlEPXqfEt1zML%0D%0AFUSZq3JGQAICoLYrmHV2bf8oLr0qd%2F6xfna%2Bda7ymjWNs%2FXwM8cIxRP7lS2v7Akq%0D%0AMKpTaqBG%2FcSHq6fdwtq%2Bd%2BwFeqAzwWEJKEsQnrLBACmlsdps75C3jV8UUSgmS1%2Bt%0D%0A%2B8yzwSabED0tj6G8ltMAEQEAAYkEuwQYAQoAJgIbAhYhBEjWpfQtYFe%2FmjeABF3o%0D%0AlJqJnI2ZBQJeFvBlBQkNLFnfAonBvSAEGQEKAGYFAlLNG4ZfFIAAAAAALgAoaXNz%0D%0AdWVyLWZwckBub3RhdGlvbnMub3BlbnBncC5maWZ0aGhvcnNlbWFuLm5ldDYxRjFG%0D%0AMjBEOTg2NzFGMjVDQTE5ODg3Qzk5MzQwOEQxMTM3QjdENTEACgkQmTQI0RN7fVF0%0D%0AYQ%2F9FEeZBVYXhDgNNFNbhYUR4b%2BPoOYSE0Vxc4O8FIcYUNBg%2BKBCyxH5fX00ri8p%0D%0Aei14fQihHp9XOPv5c5oxJplpv9gWm1LlHE8sGYXzQq4xLpQqYWfdI1mZFUOXP5Mn%0D%0AAJXt%2FB4T9ZDNm1Uwy22oZOl9lM6ZoXoX8QDTqLAXDlvqAJE%2BRSGFsGhno2tg%2BuCU%0D%0AoPHXMva0mXMX%2BDl%2B2mR2Spj2JzptyebRzls5SkI9iEyjyI3YaCQvTvuMT89CeMIB%0D%0AQ5yIG36g%2BdfeNKJHFuWfbwNBH484mM68WIkvnmZ49tc2TqELvsjZyf9Nj96PusEg%0D%0AG1HT60R5DARH6aPlZQ56EMJeMCCz4WiIunrHjxC4V4vJMPWWtAcZjBpipCmqXwA6%0D%0AtACFpcy6rZ2d5vO8YtVu1GOr7H%2F%2F%2FiBIJLng8QA73LQxrnyYkwc%2Fh62RVSt2uIql%0D%0AMX6scTAhZ4920XxIdQASteFhELsC14HJK2EmjA%2Fbmf9EcoPE7yhfZAUzIi%2FgtNf8%0D%0A4Pa%2BrHEg5AqOyWhrPR49UIw0p0N5bxli2y8393zwRe%2B6%2B7H5fJGGu06ZURlrJ7YQ%0D%0A%2F7QAflzOR4GRFYp%2BH%2B4asnvXqdCttgED8iCkVuMUz%2F%2BBHaJPYw3iBVE8doR4HTta%0D%0AEk%2BNq99MjSYN3YRowUL%2FEzkbekvuNK1jQ%2FdLX4BxPIeHUBYJEF3olJqJnI2Z7okQ%0D%0AALeSfPeatmiQ%2Be7ewInaj7n5HG%2BQofgPZ%2FCPVv75vRsStzl8eUgpgxIdwrR30n%2Bi%0D%0AFgFiiN6Kf2ErI0XusDVbY0efQ6D7TA%2FEUbRcMK6ImA01AiT9qVdNuf%2BWT%2Ft0HHHX%0D%0APtRQG9PM683dPHhSe3mC9srLQZ66AyfOybuPM4lg0FqL%2BXDtE5MdbfJrgbIn4lKV%0D%0Al7yuJ5uUVNHIzNdNM7jpv64RHghCVFYVIXWSO6oJDo0HgI5LGSagH%2FT1B3u5pi91%0D%0Al%2BwUyYezYYJzueptbdhWr%2Bs6DwsETIggw%2Fpbm2AEQ3JrB4NN3rDixDULQvpx8TuW%0D%0Axa9G0AKPMqnqiUEjI4BIEUe70viLlv7IKqyL%2FsWO8cKeVrnzJxKLUlkk8DqbQnGZ%0D%0AwLvxJk78yTx7RAOTx7SqX7LBvQkzd5rKBqzarXVmG%2FmrM%2BctaYvmMsRVXvA%2Fp7mC%0D%0Age7mvCN6qIw2IfNDvNIucXdQzgrN428hGgM80JptlwYeBLLladafNNGIYWX4L4qH%0D%0AY6O2gnLahYrMHXGHyLg%2Bs9g2vTWNXjXYqUn4W56olGwyb6MeGw9jQ49ZoGj7GQPr%0D%0AuPZmrqBiwiYwKL7o%2BMzUEAAyWgLcvN%2FDGPFrZlf3JgmwmkPvWbTe0YJhOOR6HWwp%0D%0AO1mJj5mOO3H2s5FVZcNq8ASHkBVgIPF0K6GpR%2F8Gpzo9uQINBFLNHocBEADVdBX4%0D%0AUn5Er0ZZujjJB7zGbg9PDD4iFTNNo74Qg2sf5XtvyrTnAdesZNvv4g5uS37cTO0%2F%0D%0AMPcsJ9mB7kdwQ%2FPRlaCXN04L%2FXbfjcYSLpqrGUaGmP7vNlWEp%2Be9upYqpiXLIyE7%0D%0AoyVQugrN3IJL9FD58tDWCsPdU31SrSo2rozckRfcuwbZND4pINSkE%2BLC4xkDKqcO%0D%0AIViQMI0zlHAsN0NL%2BDb%2Bo0VXXAhIb1kpqpLjcl%2Fn2NkIWqkiQ7b%2FrzeyjX2HDPcv%0D%0AOJQ61c4bPQmO4NnCAuBrlNmbm6LnKyBuz7iqtOJdZrBamMuls5nBCy4lUuMCyZ6Q%0D%0AwZ6Wa9QAM5wv1UgN9Xr%2BLqwVmjPDRwYo5nw7UT3qg1nvuLIYjZNRx5D3Pawx6mfc%0D%0ASr8hJDtKcOgGNL7cXwZj6VyQhLvf3kmjsncBn01TU6Uo8OagfeZFtThKkxq24vsQ%0D%0AiPBCBcPIP8b1V7V7NTB1AGtKBNvYT8LqeO10MEI9nR1Twpdj5R26o8AC56208Uz5%0D%0ARALWlHDJQ%2BWKjOLgkyJmzATizQX1C41xyzWhZqITbA1mrRMzct3jEoxJomOSqXkm%0D%0AfvcAIbw9vm7J%2BKj2tw2MLnK8kSk2Nirg6N%2FhexTJsg2O%2BP7xdgvgWudCqYceBiWi%0D%0AUcVUd8UlBTDdTEgKUgm2XixisjHURTOT12%2BK9wARAQABiQI8BBgBCgAmAhsMFiEE%0D%0ASNal9C1gV7%2BaN4AEXeiUmomcjZkFAl4W8GUFCQ0sVt4ACgkQXeiUmomcjZksjw%2F%2B%0D%0AOIg%2BcdquZlbYmu3ExPRcHvb37OP%2FLLa%2FeVVl163tLQoaGJeMdqiw%2BF9ShVCFQBw8%0D%0A6YVUEKijJVamqKZxsoxA9sBIEpM5XpzlZ2hvxV0oq2TfefXVMI3JI9e273CYNEsf%0D%0A8AEaYubnC5tdAoOaH4w0sAzxTiaXJ8sUjmBJy%2FHjO2MLyJXSDaufu7HE6MtLphCA%0D%0AEMzcOk1tK5krrIblodMtwhwMVKWQxpzR5TPCcVVdTosDqWm4Oo4jinoiCNam%2BGh%2B%0D%0ASlHCz9DXvDWZfZMyYaeyTShDJD03d%2FUsy%2FGWFKO7iWFb8J1OBfqQEWUBMoHxr17r%0D%0A9Zta0rhO9l6nEaZdlGPbI7ETCnNGZmgQLpHKe1TEsWqu9R%2BeNZkgYxfaLYi91jDL%0D%0A7RXqG5je93jM%2B%2FtamefuA13FWU9PczMMRHUuE4KLUXv7cBRhA7%2FN62aWlRIiHTDw%0D%0Abrkon8S56dRsQSpmSGGAFruq%2F02DKdqJBnMjlQEDKOMw5DEzSYxjbZHXoa0IUTcK%0D%0Ac9SeOFIShYImKEwTeDZDnu60E%2BcPrBQkwUipjaQL%2BfarFMsJ1GLheNUY0NGEU%2FGd%0D%0AuPFP4TTitntMa%2BxpyTqxy24J6NhHeYENAwU5ygJQRNret2UlqBbVffJCqpf3HY6%2F%0D%0AYgn5qQm1JvulKDLN%2BJXJdVJdAsxVSfy%2F3%2BqhNSsIlFc%3D%0D%0A%3D3nCl%0D%0A-----END+PGP+PUBLIC+KEY+BLOCK-----%0D%0A' \
      --compressed \
      --insecure

    curl 'http://localhost:11371/pks/add' \
      -F 'keytext=@${./ubuntu.pub}'

    popd

    sed "s|keyserver.ubuntu.com|localhost|g" -i shared/util_test.go
  '';

  postInstall = ''
    wrapProgram $out/bin/distrobuilder --prefix PATH ":" ${binPath}
  '';

  meta = with lib; {
    description = "System container image builder for LXC and LXD";
    homepage = "https://github.com/lxc/distrobuilder";
    license = licenses.asl20;
    maintainers = with maintainers; [ megheaiulian ];
    platforms = platforms.linux;
  };
}
